<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elexico AI — Presentation Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #f8fafc;
    --bg1: #ffffff;
    --bg2: #f1f5f9;
    --bg3: #e2e8f0;
    --border: rgba(14, 165, 233, 0.15);
    --border2: rgba(14, 165, 233, 0.3);
    --accent: #0ea5e9;
    --accent2: #0284c7;
    --accent3: #38bdf8;
    --accent-glow: rgba(14, 165, 233, 0.08);
    --text: #0f172a;
    --text2: #475569;
    --text3: #94a3b8;
    --success: #059669;
    --warning: #d97706;
    --danger: #dc2626;
    --font-display: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --font-serif: 'Instrument Serif', serif;
  }

  html { scroll-behavior: smooth; }

  body {
    font-family: var(--font-display);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow: hidden;
    display: flex;
  }

  /* Animated background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 50% -20%, rgba(14,165,233,0.07) 0%, transparent 70%),
      radial-gradient(ellipse 40% 60% at 0% 50%, rgba(14,165,233,0.04) 0%, transparent 60%),
      radial-gradient(ellipse 40% 40% at 100% 80%, rgba(56,189,248,0.04) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* Grid overlay */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(14,165,233,0.06) 1px, transparent 1px),
      linear-gradient(90deg, rgba(14,165,233,0.06) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  /* SIDEBAR */
  .sidebar {
    width: 260px;
    min-width: 260px;
    height: 100vh;
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 10;
    transition: width 0.3s ease;
  }

  .sidebar.collapsed { width: 64px; min-width: 64px; }
  .sidebar.collapsed .sidebar-text { display: none; }
  .sidebar.collapsed .logo-full { display: none; }
  .sidebar.collapsed .logo-icon { display: flex !important; }

  .logo-area {
    padding: 20px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    user-select: none;
  }

  .logo-icon-wrapper {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 0 20px rgba(14,165,233,0.25);
  }

  .logo-icon-wrapper svg { width: 20px; height: 20px; color: #ffffff; }

  .logo-full .brand-name {
    font-size: 18px;
    font-weight: 800;
    letter-spacing: 0.08em;
    color: var(--text);
  }
  .logo-full .brand-sub {
    font-size: 9px;
    font-family: var(--font-mono);
    color: var(--text3);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .logo-icon { display: none; }

  .sidebar-nav {
    flex: 1;
    padding: 16px 8px;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .nav-section-label {
    font-family: var(--font-mono);
    font-size: 9px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text3);
    padding: 8px 10px 4px;
    white-space: nowrap;
    overflow: hidden;
  }

  .sidebar.collapsed .nav-section-label { opacity: 0; }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text2);
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    position: relative;
  }

  .nav-item:hover { background: var(--accent-glow); color: var(--text); }
  .nav-item.active { background: var(--accent-glow); color: var(--accent); }
  .nav-item.active::before {
    content: '';
    position: absolute;
    left: 0; top: 50%;
    transform: translateY(-50%);
    width: 3px; height: 60%;
    background: var(--accent);
    border-radius: 0 3px 3px 0;
  }

  .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }

  .history-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text3);
    font-size: 11px;
    white-space: nowrap;
    overflow: hidden;
  }

  .history-item:hover { background: rgba(14,165,233,0.05); color: var(--text2); }

  .history-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
    opacity: 0.4;
    flex-shrink: 0;
  }

  .history-item-text { overflow: hidden; text-overflow: ellipsis; }

  .sidebar-footer {
    padding: 12px 8px;
    border-top: 1px solid var(--border);
  }

  /* MAIN */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    position: relative;
    z-index: 5;
  }

  /* TOP BAR */
  .topbar {
    height: 58px;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 16px;
    flex-shrink: 0;
  }

  .topbar-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text2);
    flex: 1;
  }

  .topbar-title span { color: var(--accent); }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 8px;
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    letter-spacing: 0.02em;
    white-space: nowrap;
  }

  .btn svg { width: 14px; height: 14px; }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: var(--bg);
    box-shadow: 0 0 20px rgba(14,165,233,0.2);
  }
  .btn-primary:hover { box-shadow: 0 0 30px rgba(14,165,233,0.4); transform: translateY(-1px); }

  .btn-ghost {
    background: transparent;
    color: var(--text2);
    border: 1px solid var(--border2);
  }
  .btn-ghost:hover { background: var(--accent-glow); color: var(--text); border-color: var(--accent); }

  .btn-danger {
    background: rgba(248,113,113,0.1);
    color: var(--danger);
    border: 1px solid rgba(248,113,113,0.2);
  }
  .btn-danger:hover { background: rgba(248,113,113,0.2); }

  /* CONTENT AREA */
  .content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 24px;
    scroll-behavior: smooth;
  }

  .content::-webkit-scrollbar { width: 4px; }
  .content::-webkit-scrollbar-track { background: transparent; }
  .content::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

  /* UPLOAD ZONE */
  .upload-zone {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - 130px);
    text-align: center;
    animation: fadeIn 0.6s ease;
  }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  .upload-card {
    width: 100%;
    max-width: 600px;
    background: var(--bg1);
    border: 2px dashed var(--border2);
    border-radius: 24px;
    padding: 60px 40px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }

  .upload-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(56,189,248,0.05) 0%, transparent 60%);
    pointer-events: none;
  }

  .upload-card:hover {
    border-color: var(--accent);
    background: var(--bg2);
    transform: translateY(-2px);
    box-shadow: 0 20px 60px rgba(14,165,233,0.1);
  }

  .upload-card.drag-over {
    border-color: var(--accent);
    background: var(--bg2);
    box-shadow: 0 0 40px rgba(14,165,233,0.12);
  }

  .upload-icon {
    width: 80px; height: 80px;
    background: linear-gradient(135deg, rgba(56,189,248,0.15), rgba(14,165,233,0.05));
    border: 1px solid var(--border2);
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 24px;
    box-shadow: 0 0 30px rgba(14,165,233,0.1);
  }

  .upload-icon svg { width: 36px; height: 36px; color: var(--accent); }

  .upload-title {
    font-size: 26px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 10px;
    line-height: 1.2;
  }

  .upload-sub {
    font-size: 14px;
    color: var(--text2);
    margin-bottom: 28px;
    line-height: 1.6;
  }

  .upload-formats {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .format-badge {
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 6px;
    background: rgba(56,189,248,0.08);
    border: 1px solid var(--border2);
    color: var(--accent);
    letter-spacing: 0.05em;
  }

  /* API KEY NOTICE */
  .api-notice {
    margin-top: 20px;
    max-width: 600px;
    width: 100%;
    background: rgba(251,191,36,0.05);
    border: 1px solid rgba(251,191,36,0.2);
    border-radius: 12px;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    color: var(--warning);
  }

  .api-notice svg { width: 16px; height: 16px; flex-shrink: 0; }

  /* PROCESSING STATE */
  .processing-view {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - 130px);
    animation: fadeIn 0.4s ease;
  }

  .processing-view.active { display: flex; }

  .processing-card {
    width: 100%;
    max-width: 500px;
    background: var(--bg1);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
  }

  .processing-spinner {
    width: 64px; height: 64px;
    margin: 0 auto 24px;
    position: relative;
  }

  .processing-spinner::before, .processing-spinner::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
  }

  .processing-spinner::before {
    border: 2px solid var(--border2);
  }

  .processing-spinner::after {
    border: 2px solid transparent;
    border-top-color: var(--accent);
    animation: spin 1s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .processing-spinner-inner {
    position: absolute;
    inset: 10px;
    border: 2px solid transparent;
    border-bottom-color: var(--accent3);
    border-radius: 50%;
    animation: spin 0.7s linear infinite reverse;
  }

  .processing-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
  }

  .processing-sub {
    font-size: 13px;
    color: var(--text2);
    margin-bottom: 24px;
  }

  .progress-bar-wrap {
    background: var(--bg3);
    border-radius: 100px;
    height: 6px;
    overflow: hidden;
    margin-bottom: 12px;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 100px;
    transition: width 0.4s ease;
    box-shadow: 0 0 10px rgba(14,165,233,0.4);
  }

  .progress-label {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text3);
    text-align: right;
  }

  /* RESULTS VIEW */
  .results-view {
    display: none;
    animation: fadeIn 0.5s ease;
  }

  .results-view.active { display: block; }

  /* BENTO GRID */
  .bento-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    grid-template-rows: auto auto;
    gap: 12px;
    margin-bottom: 32px;
  }

  .bento-card {
    background: var(--bg1);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .bento-card:hover { border-color: var(--border2); }

  .bento-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(56,189,248,0.3), transparent);
  }

  .bento-card.big-picture { grid-column: 1; grid-row: 1 / 3; }
  .bento-card.tone { grid-column: 2; grid-row: 1; }
  .bento-card.stats { grid-column: 3; grid-row: 1; }
  .bento-card.key-visuals { grid-column: 2 / 4; grid-row: 2; }

  .bento-label {
    font-family: var(--font-mono);
    font-size: 9px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .bento-label::before {
    content: '';
    width: 4px; height: 4px;
    border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
  }

  .big-picture-text {
    font-family: var(--font-serif);
    font-size: 17px;
    line-height: 1.7;
    color: var(--text);
    font-style: italic;
  }

  .big-picture-text em {
    font-style: normal;
    color: var(--accent3);
    font-weight: 600;
  }

  .tone-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 100px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .goal-text {
    font-size: 12px;
    color: var(--text2);
    line-height: 1.6;
  }

  .stat-number {
    font-size: 40px;
    font-weight: 800;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 11px;
    color: var(--text2);
  }

  .key-visuals-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .key-visual-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 10px;
    background: rgba(56,189,248,0.06);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 11px;
    color: var(--text2);
  }

  .key-visual-chip svg { width: 12px; height: 12px; color: var(--accent); }

  /* SLIDES SECTION */
  .slides-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .slides-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }

  .slides-count {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text3);
    background: var(--bg1);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 8px;
  }

  .slides-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 16px;
  }

  /* SLIDE CARD */
  .slide-card {
    background: var(--bg1);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.3s;
    animation: slideIn 0.4s ease both;
    cursor: pointer;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .slide-card:hover {
    border-color: var(--border2);
    transform: translateY(-3px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.08), 0 0 20px rgba(14,165,233,0.06);
  }

  .slide-thumbnail-wrap {
    position: relative;
    aspect-ratio: 16/9;
    background: var(--bg2);
    overflow: hidden;
  }

  .slide-thumbnail-wrap img {
    width: 100%; height: 100%;
    object-fit: contain;
    display: block;
    filter: brightness(0.9);
    transition: all 0.4s ease;
    opacity: 0;
  }

  .slide-thumbnail-wrap img.loaded { opacity: 1; }

  .slide-card:hover .slide-thumbnail-wrap img {
    filter: brightness(1);
    transform: scale(1.02);
  }

  .slide-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, transparent 40%, rgba(248,250,252,0.95) 100%);
    pointer-events: none;
    transition: opacity 0.3s;
  }

  .slide-card:hover .slide-overlay { opacity: 0; }

  .slide-number {
    position: absolute;
    top: 10px; left: 10px;
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    color: var(--accent);
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(8px);
    border: 1px solid var(--border2);
    border-radius: 6px;
    padding: 3px 7px;
    z-index: 2;
  }

  .slide-visual-tags {
    position: absolute;
    bottom: 8px; left: 8px; right: 8px;
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    z-index: 2;
    transition: opacity 0.3s;
  }

  .slide-card:hover .slide-visual-tags { opacity: 0; }

  .visual-tag {
    font-size: 9px;
    font-family: var(--font-mono);
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(255,255,255,0.88);
    backdrop-filter: blur(8px);
    border: 1px solid var(--border2);
    color: var(--accent3);
    letter-spacing: 0.05em;
  }

  .slide-body {
    padding: 16px;
  }

  .slide-headline {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 6px;
    line-height: 1.4;
  }

  .slide-explanation {
    font-size: 12px;
    color: var(--text2);
    line-height: 1.65;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .slide-card.expanded .slide-explanation {
    display: block;
    -webkit-line-clamp: unset;
  }

  .slide-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .slide-expand-btn {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--accent);
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px 0;
    display: flex;
    align-items: center;
    gap: 4px;
    letter-spacing: 0.05em;
  }

  .slide-expand-btn:hover { color: var(--accent3); }

  .thumbnail-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg2);
    color: var(--text3);
    font-size: 12px;
    font-family: var(--font-mono);
  }

  /* SETTINGS MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.5);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }

  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    width: 460px;
    background: var(--bg1);
    border: 1px solid var(--border2);
    border-radius: 20px;
    overflow: hidden;
    transform: translateY(20px) scale(0.97);
    transition: transform 0.25s;
    box-shadow: 0 40px 100px rgba(14,165,233,0.12), 0 8px 32px rgba(0,0,0,0.12);
  }

  .modal-overlay.open .modal { transform: translateY(0) scale(1); }

  .modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
  }

  .modal-close {
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text3);
    border-radius: 6px;
    transition: all 0.2s;
  }

  .modal-close:hover { background: rgba(14,165,233,0.08); color: var(--text); }

  .modal-body { padding: 24px; }

  .form-group { margin-bottom: 20px; }

  .form-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    margin-bottom: 8px;
    letter-spacing: 0.03em;
  }

  .form-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 10px 14px;
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text);
    outline: none;
    transition: all 0.2s;
  }

  .form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14,165,233,0.1); }

  .form-input::placeholder { color: var(--text3); }

  .form-hint {
    font-size: 11px;
    color: var(--text3);
    margin-top: 6px;
    line-height: 1.5;
  }

  .form-select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 10px 14px;
    font-family: var(--font-display);
    font-size: 12px;
    color: var(--text);
    outline: none;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2338bdf8' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    transition: all 0.2s;
  }

  .form-select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14,165,233,0.1); }

  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  /* TOAST */
  .toast-container {
    position: fixed;
    bottom: 24px; right: 24px;
    z-index: 200;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .toast {
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    backdrop-filter: blur(20px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    animation: toastIn 0.3s ease;
    max-width: 320px;
  }

  @keyframes toastIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .toast.success { background: rgba(52,211,153,0.15); border: 1px solid rgba(52,211,153,0.3); color: var(--success); }
  .toast.error { background: rgba(248,113,113,0.15); border: 1px solid rgba(248,113,113,0.3); color: var(--danger); }
  .toast.info { background: rgba(56,189,248,0.12); border: 1px solid var(--border2); color: var(--accent3); }

  .toast svg { width: 14px; height: 14px; flex-shrink: 0; }

  /* Thumbnail skeleton */
  .skeleton {
    background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
  }

  @keyframes shimmer {
    from { background-position: 200% 0; }
    to { background-position: -200% 0; }
  }

  /* File hidden */
  #fileInput { display: none; }

  /* Scrollbar for select */
  .form-select option {
    background: #ffffff;
    color: var(--text);
  }

  /* Pill indicator */
  .status-dot {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--success);
    animation: pulse-dot 2s infinite;
    margin-right: 4px;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Responsive */
  @media (max-width: 900px) {
    .bento-grid {
      grid-template-columns: 1fr 1fr;
    }
    .bento-card.big-picture { grid-column: 1 / 3; grid-row: 1; }
    .bento-card.tone { grid-column: 1; grid-row: 2; }
    .bento-card.stats { grid-column: 2; grid-row: 2; }
    .bento-card.key-visuals { grid-column: 1 / 3; grid-row: 3; }
  }

  @media (max-width: 640px) {
    .sidebar { display: none; }
    .slides-grid { grid-template-columns: 1fr; }
    .bento-grid { grid-template-columns: 1fr; }
    .bento-card.big-picture, .bento-card.key-visuals { grid-column: 1; }
    .content { padding: 16px; }
  }

  .empty-history {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text3);
    text-align: center;
    padding: 16px 10px;
    line-height: 1.6;
  }
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="logo-area" onclick="toggleSidebar()">
    <div class="logo-icon-wrapper">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
    </div>
    <div class="logo-full">
      <div class="brand-name">ELEXICO</div>
      <div class="brand-sub">AI Presentation Intelligence</div>
    </div>
    <div class="logo-icon" style="flex:1; justify-content:flex-end;">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--text3)"><path d="m9 18 6-6-6-6"/></svg>
    </div>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-section-label">Workspace</div>
    <div class="nav-item active" onclick="showUploadView()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span class="sidebar-text">Home</span>
    </div>
    <div class="nav-item" onclick="document.getElementById('fileInput').click()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <span class="sidebar-text">Upload File</span>
    </div>

    <div class="nav-section-label" style="margin-top:8px">History</div>
    <div id="historyList">
      <div class="empty-history" id="emptyHistory">No analyses yet.<br>Upload a file to begin.</div>
    </div>

    <div class="nav-section-label" style="margin-top:8px">Tools</div>
    <div class="nav-item" onclick="openSettings()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14"/></svg>
      <span class="sidebar-text">Settings & API Key</span>
    </div>
  </nav>

  <div class="sidebar-footer">
    <div class="nav-item" style="font-size:11px; color:var(--text3);">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
      <span class="sidebar-text" style="font-family:var(--font-mono); font-size:10px">v2.4 · Elexico AI</span>
    </div>
  </div>
</aside>

<!-- Main -->
<main class="main">
  <header class="topbar">
    <button class="btn btn-ghost" style="padding:7px 10px;" onclick="toggleSidebar()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="topbar-title" id="topbarTitle">Welcome to <span>Elexico AI</span></div>
    <button class="btn btn-ghost" onclick="openSettings()" style="gap:5px">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      API Key
    </button>
    <div id="apiStatus" style="display:none; align-items:center; gap:4px; font-size:11px; font-family:var(--font-mono); color:var(--success)">
      <span class="status-dot"></span> Key Active
    </div>
    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Analyze File
    </button>
  </header>

  <div class="content" id="mainContent">

    <!-- Upload View -->
    <div class="upload-zone" id="uploadView">
      <div class="upload-card" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
        </div>
        <div class="upload-title">Drop Your Presentation</div>
        <div class="upload-sub">
          Elexico AI analyzes every slide visually using multimodal AI.<br>
          Get instant insights, summaries, and visual breakdowns.
        </div>
        <div class="upload-formats">
          <span class="format-badge">PDF</span>
          <span class="format-badge">PPTX</span>
          <span class="format-badge">PPT</span>
        </div>
      </div>
      <div class="api-notice" id="apiNotice" onclick="openSettings()" style="cursor:pointer;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg>
        <span>⚠️ API key required. Click here to open Settings and paste your free Google Gemini API key from <strong>aistudio.google.com/apikey</strong>.</span>
      </div>
    </div>

    <!-- Processing View -->
    <div class="processing-view" id="processingView">
      <div class="processing-card">
        <div class="processing-spinner">
          <div class="processing-spinner-inner"></div>
        </div>
        <div class="processing-title" id="processingTitle">Converting Slides</div>
        <div class="processing-sub" id="processingSub">Rendering high-resolution images...</div>
        <div class="progress-bar-wrap">
          <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        <div class="progress-label" id="progressLabel">0%</div>
      </div>
    </div>

    <!-- Results View -->
    <div class="results-view" id="resultsView">

      <!-- Bento Grid -->
      <div class="bento-grid" id="bentoGrid">
        <div class="bento-card big-picture">
          <div class="bento-label">Big Picture Summary</div>
          <div class="big-picture-text" id="bigPictureText">
            Loading executive summary...
          </div>
        </div>
        <div class="bento-card tone">
          <div class="bento-label">Tone & Goal</div>
          <div id="toneBadge"></div>
          <div class="goal-text" id="goalText">Analyzing presentation intent...</div>
        </div>
        <div class="bento-card stats">
          <div class="bento-label">At a Glance</div>
          <div class="stat-number" id="statSlides">—</div>
          <div class="stat-label" id="statLabel">Slides Analyzed</div>
          <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;" id="statChips"></div>
        </div>
        <div class="bento-card key-visuals">
          <div class="bento-label">Key Visuals Detected</div>
          <div class="key-visuals-row" id="keyVisualsRow"></div>
        </div>
      </div>

      <!-- Slides -->
      <div class="slides-header">
        <div class="slides-title">Slide Analysis</div>
        <span class="slides-count" id="slidesCount">0 slides</span>
      </div>
      <div class="slides-grid" id="slidesGrid"></div>

    </div>

  </div>
</main>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Settings & API Configuration</div>
      <button class="modal-close" onclick="closeSettings()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Google Gemini API Key <span style="color:var(--danger);font-size:0.75rem;">(Required)</span></label>
        <input type="password" class="form-input" id="apiKeyInput" placeholder="Paste your AIza... key here">
        <div class="form-hint">⚡ Get a <strong>free</strong> key at <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--accent)">aistudio.google.com/apikey</a> — click "Create API key". Stored in browser localStorage only.</div>
      </div>
      <div class="form-group">
        <label class="form-label">AI Model</label>
        <select class="form-select" id="modelSelect">
          <option value="gemini-2.0-flash" selected>Gemini 2.0 Flash (Stable, Free ✓)</option>
          <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash-Lite (Lightest, Free ✓)</option>
          <option value="gemini-1.5-flash">Gemini 1.5 Flash (Reliable)</option>
          <option value="gemini-1.5-pro">Gemini 1.5 Pro (Most Capable)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Analysis Detail Level</label>
        <select class="form-select" id="detailSelect">
          <option value="concise">Concise — Quick overview per slide</option>
          <option value="detailed" selected>Detailed — Full analysis per slide</option>
          <option value="exhaustive">Exhaustive — In-depth with sub-elements</option>
        </select>
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label class="form-label">PDF Rendering Scale</label>
        <select class="form-select" id="scaleSelect">
          <option value="1.5">1.5x — Fast</option>
          <option value="2" selected>2x — Balanced</option>
          <option value="3">3x — High Quality</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept=".pdf,.pptx,.ppt">
<div class="toast-container" id="toastContainer"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ─── Set API key & model ───────────────────────────────────────────────────
const CURRENT_API_KEY = 'AIzaSyCErZ9YgaGeSTqMz27XHnBve0z1ZGIjaVc';
const DEFAULT_MODEL = 'gemini-2.0-flash';
localStorage.setItem('prism_api_key', CURRENT_API_KEY);

// ─── State ────────────────────────────────────────────────────────────────
let state = {
  apiKey: CURRENT_API_KEY,
  model: localStorage.getItem('prism_model') || DEFAULT_MODEL,
  detail: localStorage.getItem('prism_detail') || 'detailed',
  scale: parseFloat(localStorage.getItem('prism_scale') || '2'),
  history: JSON.parse(localStorage.getItem('prism_history') || '[]'),
  currentSlides: [],
  processing: false
};

// ─── Init ─────────────────────────────────────────────────────────────────
function init() {
  updateApiStatus();
  renderHistory();
  setupDragDrop();
  document.getElementById('fileInput').addEventListener('change', e => {
    if (e.target.files[0]) handleFile(e.target.files[0]);
    e.target.value = '';
  });
}

function updateApiStatus() {
  const el = document.getElementById('apiStatus');
  const notice = document.getElementById('apiNotice');
  if (state.apiKey) {
    el.style.display = 'flex';
    if (notice) notice.style.display = 'none';
  } else {
    el.style.display = 'none';
    if (notice) notice.style.display = 'flex';
  }
}

// ─── Sidebar ──────────────────────────────────────────────────────────────
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// ─── Settings ─────────────────────────────────────────────────────────────
function openSettings() {
  document.getElementById('apiKeyInput').value = state.apiKey;
  document.getElementById('modelSelect').value = state.model;
  document.getElementById('detailSelect').value = state.detail;
  document.getElementById('scaleSelect').value = state.scale.toString();
  document.getElementById('settingsModal').classList.add('open');
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('open');
}

function saveSettings() {
  state.apiKey = document.getElementById('apiKeyInput').value.trim();
  state.model = document.getElementById('modelSelect').value;
  state.detail = document.getElementById('detailSelect').value;
  state.scale = parseFloat(document.getElementById('scaleSelect').value);
  localStorage.setItem('prism_api_key', state.apiKey);
  localStorage.setItem('prism_model', state.model);
  localStorage.setItem('prism_detail', state.detail);
  localStorage.setItem('prism_scale', state.scale.toString());
  updateApiStatus();
  closeSettings();
  toast('Settings saved successfully', 'success');
}

// ─── Drag & Drop ──────────────────────────────────────────────────────────
function setupDragDrop() {
  const dz = document.getElementById('dropZone');
  ['dragenter','dragover'].forEach(e => dz.addEventListener(e, ev => { ev.preventDefault(); dz.classList.add('drag-over'); }));
  ['dragleave','drop'].forEach(e => dz.addEventListener(e, ev => { ev.preventDefault(); dz.classList.remove('drag-over'); }));
  dz.addEventListener('drop', ev => {
    const file = ev.dataTransfer.files[0];
    if (file) handleFile(file);
  });
}

// ─── Toast ────────────────────────────────────────────────────────────────
function toast(msg, type = 'info') {
  const icons = {
    success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
  };
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `${icons[type]}<span>${msg}</span>`;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// ─── History ──────────────────────────────────────────────────────────────
function renderHistory() {
  const list = document.getElementById('historyList');
  const empty = document.getElementById('emptyHistory');
  const items = state.history.slice().reverse().slice(0, 8);
  if (items.length === 0) { if(empty) empty.style.display = 'block'; return; }
  if(empty) empty.style.display = 'none';
  const existing = list.querySelectorAll('.history-item');
  existing.forEach(e => e.remove());
  items.forEach(item => {
    const el = document.createElement('div');
    el.className = 'history-item';
    el.innerHTML = `<div class="history-dot"></div><div class="history-item-text">${item.name}</div>`;
    el.title = item.name;
    list.appendChild(el);
  });
}

function addToHistory(name) {
  state.history.push({ name, date: Date.now() });
  if (state.history.length > 20) state.history.shift();
  localStorage.setItem('prism_history', JSON.stringify(state.history));
  renderHistory();
}

// ─── Views ────────────────────────────────────────────────────────────────
function showUploadView() {
  document.getElementById('uploadView').style.display = 'flex';
  document.getElementById('processingView').classList.remove('active');
  document.getElementById('resultsView').classList.remove('active');
  document.getElementById('topbarTitle').innerHTML = 'Welcome to <span>Elexico AI</span>';
}

function showProcessingView() {
  document.getElementById('uploadView').style.display = 'none';
  document.getElementById('processingView').classList.add('active');
  document.getElementById('resultsView').classList.remove('active');
}

function showResultsView() {
  document.getElementById('uploadView').style.display = 'none';
  document.getElementById('processingView').classList.remove('active');
  document.getElementById('resultsView').classList.add('active');
}

// ─── Progress ─────────────────────────────────────────────────────────────
function setProgress(pct, title, sub) {
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressLabel').textContent = pct + '%';
  if (title) document.getElementById('processingTitle').textContent = title;
  if (sub) document.getElementById('processingSub').textContent = sub;
}

// ─── Main Handler ─────────────────────────────────────────────────────────
async function handleFile(file) {
  if (!state.apiKey) {
    openSettings();
    toast('Please set your Google Gemini API key first', 'error');
    return;
  }

  const name = file.name.toLowerCase();
  if (!name.endsWith('.pdf') && !name.endsWith('.pptx') && !name.endsWith('.ppt')) {
    toast('Please upload a PDF or PPTX file', 'error'); return;
  }

  state.processing = true;
  state.currentSlides = [];
  showProcessingView();
  setProgress(0, 'Loading File', 'Reading file data...');
  document.getElementById('topbarTitle').innerHTML = `Analyzing <span>${file.name}</span>`;

  try {
    let slideImages = [];

    if (name.endsWith('.pdf')) {
      slideImages = await convertPDF(file);
    } else {
      slideImages = await convertPPTX(file);
    }

    if (slideImages.length === 0) {
      toast('No slides could be extracted from this file', 'error');
      showUploadView(); return;
    }

    await analyzeSlides(slideImages, file.name);
    addToHistory(file.name);

  } catch (err) {
    toast('Error: ' + err.message, 'error');
    showUploadView();
  }

  state.processing = false;
}

// ─── PDF Conversion ───────────────────────────────────────────────────────
async function convertPDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const totalPages = pdf.numPages;
  const images = [];

  for (let i = 1; i <= totalPages; i++) {
    const pct = Math.round((i / totalPages) * 40);
    setProgress(pct, 'Converting Slides', `Rendering page ${i} of ${totalPages}...`);

    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: state.scale });
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    const ctx = canvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport }).promise;
    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
    images.push(dataUrl);
  }

  return images;
}

// ─── PPTX Conversion ──────────────────────────────────────────────────────
async function convertPPTX(file) {

  const arrayBuffer = await file.arrayBuffer();
  let zip;
  try {
    zip = await JSZip.loadAsync(arrayBuffer);
  } catch(e) {
    throw new Error('Failed to read PPTX file. Please ensure it\'s a valid .pptx format.');
  }

  // Get slide list from presentation.xml
  const presXml = await zip.file('ppt/presentation.xml')?.async('string');
  if (!presXml) throw new Error('Invalid PPTX: missing presentation.xml');

  const slideRefs = [...presXml.matchAll(/r:id="(rId\d+)"/g)].map(m => m[1]);
  const presRelsXml = await zip.file('ppt/_rels/presentation.xml.rels')?.async('string');

  // Extract slide image paths
  const slideFiles = Object.keys(zip.files).filter(f =>
    f.match(/^ppt\/slides\/slide\d+\.xml$/)
  ).sort((a, b) => {
    const na = parseInt(a.match(/\d+/)?.[0] || '0');
    const nb = parseInt(b.match(/\d+/)?.[0] || '0');
    return na - nb;
  });


  // For PPTX we extract embedded images or render slide placeholders
  // True PPTX rendering without a server is limited; we'll extract slide images where possible
  // and generate canvas-rendered placeholders with extracted text for AI analysis
  const images = [];

  for (let idx = 0; idx < slideFiles.length; idx++) {
    const pct = Math.round((idx / slideFiles.length) * 40);
    setProgress(pct, 'Processing PPTX', `Extracting slide ${idx + 1} of ${slideFiles.length}...`);

    const slideFile = slideFiles[idx];
    const slideXml = await zip.file(slideFile)?.async('string');
    if (!slideXml) continue;

    // Extract visible text from slide XML
    const texts = [...slideXml.matchAll(/<a:t[^>]*>([^<]+)<\/a:t>/g)].map(m => m[1]).filter(Boolean);

    // Try to find embedded images for this slide via rels
    const slideNum = slideFile.match(/slide(\d+)\.xml/)?.[1];
    const relsPath = `ppt/slides/_rels/slide${slideNum}.xml.rels`;
    const relsXml = await zip.file(relsPath)?.async('string') || '';

    const imgRefs = [...relsXml.matchAll(/Target="\.\.\/media\/([^"]+)"/g)].map(m => m[1]);
    let firstImg = null;

    for (const ref of imgRefs) {
      const imgFile = zip.file(`ppt/media/${ref}`);
      if (imgFile && ref.match(/\.(png|jpg|jpeg|gif|bmp|webp)/i)) {
        const blob = await imgFile.async('blob');
        firstImg = await blobToDataUrl(blob);
        break;
      }
    }

    // Render a stylized slide canvas
    const canvas = document.createElement('canvas');
    canvas.width = 1280; canvas.height = 720;
    const ctx = canvas.getContext('2d');

    // Background
    ctx.fillStyle = '#f8fafc';
    ctx.fillRect(0, 0, 1280, 720);

    // Subtle grid
    ctx.strokeStyle = 'rgba(14,165,233,0.07)';
    ctx.lineWidth = 1;
    for (let x = 0; x < 1280; x += 60) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, 720); ctx.stroke(); }
    for (let y = 0; y < 720; y += 60) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(1280, y); ctx.stroke(); }

    // Accent bar
    const grad = ctx.createLinearGradient(0, 0, 1280, 0);
    grad.addColorStop(0, '#38bdf8');
    grad.addColorStop(1, '#0ea5e9');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, 1280, 4);

    // Embed background image if found
    if (firstImg) {
      try {
        const img = await loadImage(firstImg);
        ctx.globalAlpha = 0.15;
        const ar = img.width / img.height;
        const cAr = 1280 / 720;
        let dw = 1280, dh = 720, dx = 0, dy = 0;
        if (ar > cAr) { dh = 720; dw = 720 * ar; dx = -(dw - 1280) / 2; }
        else { dw = 1280; dh = 1280 / ar; dy = -(dh - 720) / 2; }
        ctx.drawImage(img, dx, dy, dw, dh);
        ctx.globalAlpha = 1;
      } catch(e) {}
    }

    // Slide number
    ctx.font = '500 14px "DM Mono", monospace';
    ctx.fillStyle = 'rgba(14,165,233,0.7)';
    ctx.fillText(`SLIDE ${idx + 1}`, 40, 48);

    // Render text
    if (texts.length > 0) {
      const title = texts[0];
      ctx.font = '700 42px "Syne", sans-serif';
      ctx.fillStyle = '#0f172a';
      ctx.fillText(truncate(title, 38), 60, 120);

      ctx.font = '400 20px "Syne", sans-serif';
      ctx.fillStyle = '#475569';
      let y = 180;
      for (let t = 1; t < Math.min(texts.length, 12); t++) {
        if (texts[t].trim().length < 3) continue;
        ctx.fillText(truncate(texts[t], 72), 60, y);
        y += 38;
        if (y > 620) break;
      }
    }

    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
    images.push({ dataUrl, extractedText: texts.join(' ') });
  }

  return images;
}

function truncate(str, n) { return str.length > n ? str.slice(0, n) + '…' : str; }
function blobToDataUrl(blob) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(blob);
  });
}
function loadImage(src) {
  return new Promise((res, rej) => {
    const img = new Image();
    img.onload = () => res(img);
    img.onerror = rej;
    img.src = src;
  });
}

// ─── AI Analysis ──────────────────────────────────────────────────────────
async function callGemini(prompt, imageBase64, mediaType) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${state.model}:generateContent?key=${state.apiKey}`;
  const parts = [];
  if (imageBase64) {
    parts.push({ inline_data: { mime_type: mediaType, data: imageBase64 } });
  }
  parts.push({ text: prompt });

  let response;
  try {
    response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts }],
        generationConfig: { temperature: 0.3, maxOutputTokens: 2048 }
      })
    });
  } catch(networkErr) {
    throw new Error('Network error: Could not reach Gemini API. Check your internet connection.');
  }

  if (!response.ok) {
    let err = {};
    try { err = await response.json(); } catch(e) {}
    const msg = err.error?.message || `Gemini API error ${response.status}`;
    console.error('Gemini API Error:', response.status, msg);
    if (response.status === 429) {
      throw new Error('Rate limit reached. Please wait 1 minute and try again.');
    }
    if (response.status === 400 || response.status === 403) {
      throw new Error('API key invalid or unauthorized. Please check your key in Settings.');
    }
    throw new Error(msg);
  }

  const data = await response.json();
  const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
  if (!text) throw new Error('Empty response from Gemini. Try again.');
  return text;
}

async function analyzeSlides(slideData, filename) {
  const total = slideData.length;
  const slideResults = [];
  const allVisualTags = new Set();

  setProgress(40, 'Analyzing with AI', `Processing slide 1 of ${total}...`);

  const detailPrompts = {
    concise: 'Provide a concise 2-3 sentence explanation of this slide.',
    detailed: 'Provide a detailed explanation of this slide including all visible text, charts, diagrams, images, and data. Identify visual element types.',
    exhaustive: 'Provide an exhaustive analysis of this slide. Describe every visual element, chart type, data shown, layout structure, text hierarchy, color usage, and the slide\'s specific role in the presentation.'
  };

  for (let i = 0; i < total; i++) {
    const pct = 40 + Math.round((i / total) * 45);
    setProgress(pct, 'AI Analyzing Slides', `Analyzing slide ${i + 1} of ${total}...`);

    const slideInfo = typeof slideData[i] === 'string' ? { dataUrl: slideData[i], extractedText: '' } : slideData[i];
    const base64 = slideInfo.dataUrl.split(',')[1];
    const mediaType = slideInfo.dataUrl.startsWith('data:image/png') ? 'image/png' : 'image/jpeg';
    const textHint = slideInfo.extractedText ? `\nExtracted text from file: "${slideInfo.extractedText.slice(0, 500)}"` : '';

    const prompt = `You are Elexico AI, an expert presentation analyst. Analyze this presentation slide (slide ${i + 1} of ${total}).${textHint}

${detailPrompts[state.detail]}

Respond ONLY with valid JSON (no markdown, no code fences):
{
  "headline": "Short compelling title for this slide (max 8 words)",
  "explanation": "Detailed slide explanation here",
  "visualElements": ["chart", "diagram", "text", "image", "table", "icon", "logo", "graph"],
  "slideType": "title|content|data|image|summary|agenda|quote|divider|other"
}`;

    try {
      const rawText = await callGemini(prompt, base64, mediaType);

      let parsed;
      try {
        const cleaned = rawText.replace(/```json\n?|\n?```/g, '').trim();
        parsed = JSON.parse(cleaned);
      } catch(e) {
        parsed = {
          headline: `Slide ${i + 1}`,
          explanation: rawText,
          visualElements: [],
          slideType: 'content'
        };
      }

      parsed.visualElements?.forEach(v => allVisualTags.add(v));
      slideResults.push({ ...parsed, imageDataUrl: slideInfo.dataUrl, slideNum: i + 1 });

    } catch(err) {
      slideResults.push({
        headline: `Slide ${i + 1}`,
        explanation: `Analysis failed: ${err.message}`,
        visualElements: [],
        slideType: 'content',
        imageDataUrl: slideInfo.dataUrl,
        slideNum: i + 1,
        error: true
      });
    }

    if (i < total - 1) await sleep(200);
  }

  // Generate global summary
  setProgress(88, 'Generating Executive Summary', 'Creating big picture overview...');

  const summaryContext = slideResults.map((s, i) => `Slide ${i+1} (${s.slideType}): ${s.headline} — ${s.explanation?.slice(0, 200)}`).join('\n');

  let summaryData = { bigPicture: '', tone: '', goal: '', toneColor: 'info' };

  try {
    const summaryPrompt = `You are Elexico AI, an expert presentation strategist. Based on this ${total}-slide presentation analysis from "${filename}", generate an executive summary.

SLIDE ANALYSES:
${summaryContext}

Respond ONLY with valid JSON (no markdown, no code fences):
{
  "bigPicture": "Exactly 3 sentences. Sentence 1: what this presentation is about. Sentence 2: its key argument or data. Sentence 3: the intended outcome or call to action. Wrap 2-3 key terms in <em> tags.",
  "tone": "One word: Professional|Persuasive|Educational|Inspirational|Technical|Analytical|Casual|Executive",
  "goal": "One sentence describing the presentation's primary goal and target audience.",
  "toneColor": "blue|green|yellow|purple|orange"
}`;

    const raw = await callGemini(summaryPrompt, null, null);
    const cleaned = raw.replace(/```json\n?|\n?```/g, '').trim();
    summaryData = JSON.parse(cleaned);
  } catch(e) {
    summaryData.bigPicture = slideResults.map(s => s.headline).join('. ') + '.';
    summaryData.tone = 'Professional';
    summaryData.goal = `A ${total}-slide presentation covering key topics.`;
    summaryData.toneColor = 'blue';
  }

  setProgress(100, 'Complete!', 'Building your results dashboard...');
  await sleep(600);

  renderResults(slideResults, summaryData, allVisualTags);
  showResultsView();
  toast(`Analysis complete! ${total} slides processed.`, 'success');
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ─── Render Results ───────────────────────────────────────────────────────
function renderResults(slides, summary, visualTags) {
  // Big picture
  document.getElementById('bigPictureText').innerHTML = summary.bigPicture || 'Summary not available.';

  // Tone
  const toneColors = {
    blue: { bg: 'rgba(56,189,248,0.12)', border: 'rgba(56,189,248,0.3)', color: '#38bdf8' },
    green: { bg: 'rgba(52,211,153,0.1)', border: 'rgba(52,211,153,0.3)', color: '#34d399' },
    yellow: { bg: 'rgba(251,191,36,0.1)', border: 'rgba(251,191,36,0.3)', color: '#fbbf24' },
    purple: { bg: 'rgba(167,139,250,0.1)', border: 'rgba(167,139,250,0.3)', color: '#a78bfa' },
    orange: { bg: 'rgba(251,146,60,0.1)', border: 'rgba(251,146,60,0.3)', color: '#fb923c' }
  };
  const tc = toneColors[summary.toneColor] || toneColors.blue;
  document.getElementById('toneBadge').innerHTML = `<div class="tone-badge" style="background:${tc.bg}; border:1px solid ${tc.border}; color:${tc.color}">
    <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
    ${summary.tone || 'Professional'}
  </div>`;
  document.getElementById('goalText').textContent = summary.goal || '';

  // Stats
  document.getElementById('statSlides').textContent = slides.length;
  document.getElementById('statLabel').textContent = 'Slides Analyzed';

  const types = {};
  slides.forEach(s => { types[s.slideType] = (types[s.slideType] || 0) + 1; });
  const chipsEl = document.getElementById('statChips');
  chipsEl.innerHTML = '';
  Object.entries(types).slice(0, 4).forEach(([type, count]) => {
    const chip = document.createElement('div');
    chip.className = 'key-visual-chip';
    chip.innerHTML = `<span style="color:var(--accent);font-weight:600">${count}</span> ${type}`;
    chipsEl.appendChild(chip);
  });

  // Key visuals
  const kvRow = document.getElementById('keyVisualsRow');
  kvRow.innerHTML = '';
  const visualIcons = {
    chart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
    diagram: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
    image: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
    table: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>',
    text: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>',
    graph: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    logo: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>'
  };
  [...visualTags].forEach(tag => {
    const chip = document.createElement('div');
    chip.className = 'key-visual-chip';
    chip.innerHTML = `${visualIcons[tag] || '•'} ${tag.charAt(0).toUpperCase() + tag.slice(1)}`;
    kvRow.appendChild(chip);
  });
  if (visualTags.size === 0) kvRow.innerHTML = '<div class="key-visual-chip"><span style="color:var(--text3)">No special visuals detected</span></div>';

  // Slides grid
  document.getElementById('slidesCount').textContent = `${slides.length} slides`;
  const grid = document.getElementById('slidesGrid');
  grid.innerHTML = '';

  slides.forEach((slide, idx) => {
    const card = document.createElement('div');
    card.className = 'slide-card';
    card.style.animationDelay = (idx * 0.05) + 's';

    const tagsHtml = (slide.visualElements || []).slice(0, 4).map(t =>
      `<span class="visual-tag">${t}</span>`
    ).join('');

    card.innerHTML = `
      <div class="slide-thumbnail-wrap">
        <div class="thumbnail-placeholder skeleton" id="skeleton-${idx}"></div>
        <img src="" alt="Slide ${slide.slideNum}" id="img-${idx}" onload="this.classList.add('loaded'); document.getElementById('skeleton-${idx}').style.display='none'">
        <div class="slide-overlay"></div>
        <div class="slide-number">${slide.slideNum}</div>
        <div class="slide-visual-tags">${tagsHtml}</div>
      </div>
      <div class="slide-body">
        <div class="slide-headline">${escapeHtml(slide.headline || `Slide ${slide.slideNum}`)}</div>
        <div class="slide-explanation">${escapeHtml(slide.explanation || '')}</div>
        <div class="slide-footer">
          <span class="key-visual-chip" style="font-size:10px; padding:2px 7px">${slide.slideType}</span>
          <button class="slide-expand-btn" onclick="toggleExpand(this)">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            More
          </button>
        </div>
      </div>`;

    grid.appendChild(card);

    // Lazy load image
    setTimeout(() => {
      const imgEl = document.getElementById(`img-${idx}`);
      if (imgEl) imgEl.src = slide.imageDataUrl;
    }, idx * 80);
  });
}

function toggleExpand(btn) {
  const card = btn.closest('.slide-card');
  card.classList.toggle('expanded');
  const icon = btn.querySelector('svg polyline');
  if (card.classList.contains('expanded')) {
    btn.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg> Less';
  } else {
    btn.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg> More';
  }
}

function escapeHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── Show Upload View on nav ───────────────────────────────────────────────
document.querySelectorAll('.nav-item').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
  });
});

// Close modal on overlay click
document.getElementById('settingsModal').addEventListener('click', function(e) {
  if (e.target === this) closeSettings();
});

init();
</script>
</body>
</html>
